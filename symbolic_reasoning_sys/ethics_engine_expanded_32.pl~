% ETHICS ENGINE EXPANDED (32 Scenarios, 4 Scenario Parameters)

% == SUMMARY ==
% - Included a new legal_context parameter and extended the scenarios to facilitate this new parameter
% - Reintroduced ethical gaps by selectively removing overly general rules

% == RULE MODULE ==

% UTILITARIAN RULES: aim to maximize collective benefit and well-being
utilitarian_rule(scenario(dropped_wallet, true, true, many_people_around, none), return_wallet).
utilitarian_rule(scenario(dropped_wallet, true, true, many_people_around, cctv_visible), return_wallet).
utilitarian_rule(scenario(dropped_wallet, true, true, many_people_around, law_posted), return_wallet).
utilitarian_rule(scenario(dropped_wallet, true, true, many_people_around, unclear), return_wallet).
utilitarian_rule(scenario(dropped_wallet, true, true, isolated_area, _), return_wallet).
utilitarian_rule(scenario(dropped_wallet, false, true, many_people_around, _), return_wallet).
utilitarian_rule(scenario(dropped_wallet, false, true, isolated_area, none), leave_wallet).
utilitarian_rule(scenario(dropped_wallet, false, true, isolated_area, unclear), leave_wallet).

% DEONTOLOGICAL RULES: follow moral duties regardless of consequences
deontological_rule(scenario(dropped_wallet, _, true, _, _), leave_wallet).
deontological_rule(scenario(dropped_wallet, _, false, many_people_around, _), leave_wallet).
deontological_rule(scenario(dropped_wallet, true, _, _, _), return_wallet).
deontological_rule(scenario(dropped_wallet, false, true, many_people_around, _), return_wallet).
deontological_rule(scenario(dropped_wallet, false, true, isolated_area, _), leave_wallet).
deontological_rule(scenario(dropped_wallet, false, true, _, law_posted), return_wallet).
deontological_rule(scenario(dropped_wallet, _, true, _, unclear), leave_wallet).
deontological_rule(scenario(dropped_wallet, true, _, _, unclear), leave_wallet).

% SELF-INTEREST RULES: model personal gain-oriented behavior
self_interest_rule(scenario(dropped_wallet, false, true, isolated_area, none), take_wallet).
self_interest_rule(scenario(dropped_wallet, false, true, isolated_area, unclear), take_wallet).
self_interest_rule(scenario(dropped_wallet, false, true, isolated_area, cctv_visible), leave_wallet).
self_interest_rule(scenario(dropped_wallet, false, true, isolated_area, law_posted), leave_wallet).
self_interest_rule(scenario(dropped_wallet, false, false, isolated_area, none), take_wallet).
self_interest_rule(scenario(dropped_wallet, false, false, isolated_area, unclear), take_wallet).
self_interest_rule(scenario(dropped_wallet, true, false, isolated_area, _), leave_wallet).

% == SCENARIO MODULE ==

scenario(dropped_wallet_1, scenario(dropped_wallet, true, true, many_people_around, none)).
scenario(dropped_wallet_2, scenario(dropped_wallet, true, true, many_people_around, cctv_visible)).
scenario(dropped_wallet_3, scenario(dropped_wallet, true, true, many_people_around, law_posted)).
scenario(dropped_wallet_4, scenario(dropped_wallet, true, true, many_people_around, unclear)).
scenario(dropped_wallet_5, scenario(dropped_wallet, true, true, isolated_area, none)).
scenario(dropped_wallet_6, scenario(dropped_wallet, true, true, isolated_area, cctv_visible)).
scenario(dropped_wallet_7, scenario(dropped_wallet, true, true, isolated_area, law_posted)).
scenario(dropped_wallet_8, scenario(dropped_wallet, true, true, isolated_area, unclear)).
scenario(dropped_wallet_9, scenario(dropped_wallet, true, false, many_people_around, none)).
scenario(dropped_wallet_10, scenario(dropped_wallet, true, false, many_people_around, cctv_visible)).
scenario(dropped_wallet_11, scenario(dropped_wallet, true, false, many_people_around, law_posted)).
scenario(dropped_wallet_12, scenario(dropped_wallet, true, false, many_people_around, unclear)).
scenario(dropped_wallet_13, scenario(dropped_wallet, true, false, isolated_area, none)).
scenario(dropped_wallet_14, scenario(dropped_wallet, true, false, isolated_area, cctv_visible)).
scenario(dropped_wallet_15, scenario(dropped_wallet, true, false, isolated_area, law_posted)).
scenario(dropped_wallet_16, scenario(dropped_wallet, true, false, isolated_area, unclear)).
scenario(dropped_wallet_17, scenario(dropped_wallet, false, true, many_people_around, none)).
scenario(dropped_wallet_18, scenario(dropped_wallet, false, true, many_people_around, cctv_visible)).
scenario(dropped_wallet_19, scenario(dropped_wallet, false, true, many_people_around, law_posted)).
scenario(dropped_wallet_20, scenario(dropped_wallet, false, true, many_people_around, unclear)).
scenario(dropped_wallet_21, scenario(dropped_wallet, false, true, isolated_area, none)).
scenario(dropped_wallet_22, scenario(dropped_wallet, false, true, isolated_area, cctv_visible)).
scenario(dropped_wallet_23, scenario(dropped_wallet, false, true, isolated_area, law_posted)).
scenario(dropped_wallet_24, scenario(dropped_wallet, false, true, isolated_area, unclear)).
scenario(dropped_wallet_25, scenario(dropped_wallet, false, false, many_people_around, none)).
scenario(dropped_wallet_26, scenario(dropped_wallet, false, false, many_people_around, cctv_visible)).
scenario(dropped_wallet_27, scenario(dropped_wallet, false, false, many_people_around, law_posted)).
scenario(dropped_wallet_28, scenario(dropped_wallet, false, false, many_people_around, unclear)).
scenario(dropped_wallet_29, scenario(dropped_wallet, false, false, isolated_area, none)).
scenario(dropped_wallet_30, scenario(dropped_wallet, false, false, isolated_area, cctv_visible)).
scenario(dropped_wallet_31, scenario(dropped_wallet, false, false, isolated_area, law_posted)).
scenario(dropped_wallet_32, scenario(dropped_wallet, false, false, isolated_area, unclear)).

% == GAP DETECTION ==

ethical_gap(ScenarioName) :-
    scenario(ScenarioName, S),
    findall(A, (
        utilitarian_rule(S, A);
        deontological_rule(S, A);
        self_interest_rule(S, A)
    ), Actions),
    Actions == [].


% == WEIGHT MODULE ==

weight(utilitarian, 0.3).
weight(deontological, 0.3).
weight(self_interest, 0.3).

% == UTILITY MODULE ==

justify(RuleName, Action, Justification) :-
    format(atom(Justification), 'Action ~w justified by ~w ethics based on scenario context: ~w.', [Action, RuleName, Action]).

conflicting_recommendations(Scenario, ConflictFlag) :-
    findall(A, (
        utilitarian_rule(Scenario, A);
        deontological_rule(Scenario, A);
        self_interest_rule(Scenario, A)
    ), RawActions),
    sort(RawActions, Unique),
    length(Unique, L),
    (L > 1 -> ConflictFlag = true ; ConflictFlag = false).

rule_sources(Scenario, Action, Sources) :-
    findall(R, (
        (utilitarian_rule(Scenario, Action), R = utilitarian);
        (deontological_rule(Scenario, Action), R = deontological);
        (self_interest_rule(Scenario, Action), R = self_interest)
    ), Sources).

unmatched_scenario(Name) :-
    scenario(Name, S),
    \+ (utilitarian_rule(S,_); deontological_rule(S,_); self_interest_rule(S,_)).

% == Decision MODULE ==

make_decision(ScenarioName, Action, Justification, Score) :-
    ( ethical_gap(ScenarioName) ->
        Action = undecided,
        Justification = 'No ethical rule matched. Scenario flagged for evolutionary probing.',
        Score = 0.0
    ;
        scenario(ScenarioName, Scenario),
        findall((W,A), (
            (utilitarian_rule(Scenario, A), weight(utilitarian, W));
            (deontological_rule(Scenario, A), weight(deontological, W), A \= act_transparently);
            (self_interest_rule(Scenario, A), weight(self_interest, W))
        ), Decisions),
        sort(Decisions, UniqueDecisions),
        maplist(arg(1), UniqueDecisions, Weights),
        maplist(arg(2), UniqueDecisions, _),
        sum_list(Weights, RawScore),
        length(UniqueDecisions, Count),
        (Count > 0 -> Score is RawScore / Count ; Score = 0.0),
        max_member((W, Action), UniqueDecisions),
        scenario(ScenarioName, Scenario),
        findall((Rw, Rs), (
            (utilitarian_rule(Scenario, A), A == Action, weight(utilitarian, Rw), Rs = utilitarian);
            (deontological_rule(Scenario, A), A == Action, weight(deontological, Rw), Rs = deontological);
            (self_interest_rule(Scenario, A), A == Action, weight(self_interest, Rw), Rs = self_interest)
        ), RuleWeightPairs),
        max_member((_, Rule), RuleWeightPairs),
        justify(Rule, Action, Justification)
    ).
